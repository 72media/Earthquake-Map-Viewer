<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô‡πÑ‡∏´‡∏ß + ‡∏ó‡∏∏‡πà‡∏ô‡∏™‡∏∂‡∏ô‡∏≤‡∏°‡∏¥ (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css">
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --primary-color: #005c97;
      --secondary-color: #002f4b;
      --accent-color: #ff5722;
      --tmd-color: #9c27b0;
      --bg-light: #f2f6fa;
      --text-dark: #333;
      --text-light: #fff;
      --graph-bg: #e6f0fa;
    }

    body {
      margin: 0;
      font-family: 'Sarabun', sans-serif;
      display: flex;
      flex-direction: row;
      height: 100vh;
      background-color: var(--bg-light);
      overflow: hidden;
    }

    /* Sidebar Styles */
    #sidebar {
      width: 360px;
      background: linear-gradient(160deg, var(--secondary-color), var(--primary-color));
      color: var(--text-light);
      padding: 1rem;
      display: flex;
      flex-direction: column;
      box-shadow: 3px 0 5px rgba(0,0,0,0.2);
      z-index: 1000;
    }

    .sidebar-content {
      overflow-y: auto;
      flex: 1;
      padding-right: 5px; 
    }

    .sidebar-content::-webkit-scrollbar { width: 6px; }
    .sidebar-content::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.3); border-radius: 3px; }

    #thai-clock {
      background: rgba(0,0,0,0.2);
      padding: 0.8rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      text-align: center;
      border: 1px solid rgba(255,255,255,0.1);
    }

    .map-controls {
      background-color: rgba(0,0,0,0.2);
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
    }

    .control-group { margin-bottom: 0.8rem; }
    .control-group label { display: block; margin-bottom: 0.3rem; font-size: 0.9rem; opacity: 0.9; }

    select, input[type="file"] {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid rgba(255,255,255,0.3);
      border-radius: 4px;
      background-color: rgba(255,255,255,0.1);
      color: white;
      box-sizing: border-box; 
    }
    
    button {
      width: 100%;
      padding: 0.6rem;
      border: none;
      border-radius: 4px;
      color: white;
      font-family: 'Sarabun', sans-serif;
      cursor: pointer;
      font-weight: 600;
      transition: transform 0.1s, opacity 0.2s;
      margin-bottom: 0.5rem;
    }
    button:active { transform: scale(0.98); }
    button:hover { opacity: 0.9; }

    #load-usgs { background-color: #00bcd4; }
    #load-tmd { background-color: var(--tmd-color); }
    #clear-data { background-color: #f44336; margin-top: 0.5rem;}

    #stats {
      background: rgba(0,0,0,0.2);
      padding: 0.8rem;
      border-radius: 8px;
      font-size: 0.85rem;
      margin-bottom: 1rem;
    }
    .stat-item { display: flex; justify-content: space-between; margin-bottom: 0.3rem; }
    .stat-value { font-weight: bold; color: #ffeb3b; }

    .event-item {
      background: rgba(255,255,255,0.1);
      padding: 0.8rem;
      border-radius: 6px;
      margin-bottom: 0.5rem;
      cursor: pointer;
      transition: background 0.2s;
      border-left: 3px solid transparent;
    }
    .event-item:hover { background: rgba(255,255,255,0.2); }
    .event-item.active { background: rgba(255,255,255,0.25); border-left-color: var(--accent-color); }

    .mag-badge {
      display: inline-block;
      width: 28px; height: 28px;
      border-radius: 50%;
      text-align: center;
      line-height: 28px;
      font-weight: bold;
      color: #333;
      margin-right: 10px;
      font-size: 0.8rem;
    }
    .mag-1 { background-color: #a5d6a7; }
    .mag-2 { background-color: #fff176; }
    .mag-3 { background-color: #ffb74d; }
    .mag-4 { background-color: #ff8a65; }
    .mag-5 { background-color: #e57373; }
    .mag-6 { background-color: #f44336; color: white; }
    .mag-7 { background-color: #d32f2f; color: white; }

    .tmd-link-btn {
        display: inline-block;
        background-color: #005c97;
        color: white !important;
        padding: 4px 8px;
        border-radius: 4px;
        text-decoration: none;
        font-size: 0.8rem;
        margin-top: 5px;
        transition: background 0.2s;
    }
    .tmd-link-btn:hover { background-color: #003d61; }

    #loading {
      text-align: center;
      padding: 10px;
      background: rgba(0,0,0,0.5);
      border-radius: 4px;
      display: none;
      margin-bottom: 10px;
    }

    #map { flex: 1; height: 100vh; }

    .popup-content { min-width: 250px; }
    .popup-content .graph-frame {
      position: relative;
      width: 100%;
      margin-top: 10px;
      background-color: var(--graph-bg);
      border: 2px solid rgba(0, 92, 151, 0.2);
      border-radius: 6px;
      overflow: hidden;
      transition: all 0.3s ease;
    }
    .popup-content .graph-frame img {
      width: 100%;
      height: auto;
      display: block;
    }
    .fullscreen-trigger { cursor: zoom-in; }
    
    dialog#fullscreenDialog {
      border: none; 
      padding: 0; 
      background: rgba(0,0,0,0.9);
      max-width: 100vw;
      max-height: 100vh;
    }
    dialog::backdrop { background: rgba(0,0,0,0.8); }

    @media (max-width: 768px) {
      body { flex-direction: column; }
      #sidebar { width: 100%; height: 45vh; padding: 0.5rem; box-sizing: border-box;}
      #map { height: 55vh; }
      .sidebar-content { padding-right: 0; }
    }
  </style>
</head>
<body>

  <div id="sidebar">
    <div id="thai-clock">
      <div id="date-display" style="font-size: 0.9rem; opacity: 0.8;">-</div>
      <div id="time-display" style="font-size: 1.4rem; font-weight: bold;">--:--:--</div>
    </div>

    <div class="sidebar-content">
      <div class="map-controls">
        <div class="control-group">
          <label>üì° ‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô‡πÑ‡∏´‡∏ß:</label>
          <button id="load-usgs">üåç ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÇ‡∏•‡∏Å (USGS)</button>
          <button id="load-tmd">üáπüá≠ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏Å‡∏≠‡∏á‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏Ø (TMD)</button>
        </div>

        <div class="control-group">
          <label>üåä ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö:</label>
           <div style="font-size: 0.85rem; background: rgba(255,255,255,0.1); padding: 5px; border-radius: 4px;">
             ‚úÖ ‡∏ó‡∏∏‡πà‡∏ô‡∏™‡∏∂‡∏ô‡∏≤‡∏°‡∏¥ (2 ‡∏à‡∏∏‡∏î)<br>
             ‚úÖ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ‡∏ï‡∏£‡∏ß‡∏à‡∏ß‡∏±‡∏î (‡πÄ‡∏ô‡∏õ‡∏¥‡∏î‡∏≠‡∏£‡πå/‡∏•‡∏Å‡πÄ‡∏ã‡∏≠‡∏°‡∏≤‡πÄ‡∏ß)
           </div>
        </div>

        <div class="control-group">
          <label>üó∫Ô∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà:</label>
          <select id="map-type">
            <option value="googleHybrid">Google Hybrid (‡∏î‡∏≤‡∏ß‡πÄ‡∏ó‡∏µ‡∏¢‡∏°+‡∏ñ‡∏ô‡∏ô)</option>
            <option value="osm">OpenStreetMap (‡∏ñ‡∏ô‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥)</option>
            <option value="satellite">Esri Satellite (‡∏î‡∏≤‡∏ß‡πÄ‡∏ó‡∏µ‡∏¢‡∏°‡∏•‡πâ‡∏ß‡∏ô)</option>
          </select>
        </div>

        <div class="control-group">
          <label>üìÇ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ô‡∏ß‡∏£‡∏≠‡∏¢‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô (GeoJSON):</label>
          <input type="file" id="gpxInput" accept=".geojson,.json">
        </div>
        
        <button id="clear-data">üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô‡πÑ‡∏´‡∏ß</button>
      </div>

      <div id="stats">
        <div class="stat-item"><span>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå:</span> <span id="stat-count" class="stat-value">0</span></div>
        <div class="stat-item"><span>‡∏Ç‡∏ô‡∏≤‡∏î‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î:</span> <span id="stat-max" class="stat-value">-</span></div>
        <div class="stat-item"><span>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏∂‡∏Å‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢:</span> <span id="stat-depth" class="stat-value">-</span></div>
        <div class="stat-item"><span>‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î:</span> <span id="stat-update" class="stat-value">-</span></div>
      </div>

      <div id="loading">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
      <div id="event-list"></div>
    </div>
  </div>

  <div id="map"></div>

  <dialog id="fullscreenDialog">
    <button onclick="document.getElementById('fullscreenDialog').close()" 
            style="position:absolute;top:10px;right:20px;font-size:24px;color:white;background:none;border:none;cursor:pointer;width:auto;">‚úï ‡∏õ‡∏¥‡∏î</button>
    <img id="fullscreenImage" src="" style="max-width: 95vw; max-height: 95vh; display: block; margin: auto; padding-top: 20px;">
  </dialog>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

  <script>
    // --- CONFIGURATION ---
    const TMD_FEED_URL = "https://eq.tmd.go.th/feed/rss_local.xml"; 
    const USGS_FEED_URL = "https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/4.5_week.geojson";
    const PROXY_LIST = [
        "https://corsproxy.io/?",
        "https://api.allorigins.win/raw?url=",
        "https://thingproxy.freeboard.io/fetch/"
    ];

    // --- ICONS ---
    const quakeIcon = L.icon({
      iconUrl: 'https://maphub.net/media/markers/b/mo/bmoqwdmaegtllls8/80.png',
      iconSize: [30, 30], iconAnchor: [15, 30], popupAnchor: [0, -30]
    });

    const tsunamiIcon = L.icon({
      iconUrl: 'https://maphub.net/media/markers/3/ge/3geqzkryfqwmgmiu/80.png',
      iconSize: [32, 32], iconAnchor: [16, 32], popupAnchor: [0, -32]
    });
    
    const stationIcon = L.icon({
      iconUrl: 'https://maphub.net/media/markers/5/ub/5ub2ccvazhf9fpb4/80.png',
      iconSize: [32, 32], iconAnchor: [16, 32], popupAnchor: [0, -32]
    });

    // --- STATIC DATA ---
    const tsunamiBuoys = [
      {
        lat: 8.86000, lng: 88.55000, name: "‡∏ó‡∏∏‡πà‡∏ô‡∏™‡∏∂‡∏ô‡∏≤‡∏°‡∏¥ 23401",
        description: "‡∏´‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏Å‡∏≤‡∏∞‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï‡πÑ‡∏õ‡∏ó‡∏≤‡∏á‡∏ó‡∏¥‡∏®‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏ï‡∏Å ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á 965 ‡∏Å‡∏°.",
        graph: "https://www.ndbc.noaa.gov/plot?station=23401&meas=hght&uom=M&width=1000&height=550"
      },
      {
        lat: 9.54100, lng: 95.66800, name: "‡∏ó‡∏∏‡πà‡∏ô‡∏™‡∏∂‡∏ô‡∏≤‡∏°‡∏¥ 23461",
        description: "‡∏´‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏Å‡∏≤‡∏∞‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï‡πÑ‡∏õ‡∏ó‡∏≤‡∏á‡∏ó‡∏¥‡∏®‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏ï‡∏Å ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á 340 ‡∏Å‡∏°.",
        graph: "https://www.ndbc.noaa.gov/plot?station=23461&meas=hght&uom=M&width=1000&height=550"
      }
    ];
    
    const seismicStations = [
      {
        lat: 19.780390734463694, lng: 96.14079826383701,
        name: "‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ‡∏ï‡∏£‡∏ß‡∏à‡∏ß‡∏±‡∏î‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô‡πÑ‡∏´‡∏ß‡πÄ‡∏ô‡∏õ‡∏¥‡∏î‡∏≠‡∏£‡πå",
        description: "‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ‡∏ï‡∏£‡∏ß‡∏à‡∏ß‡∏±‡∏î‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô‡πÑ‡∏´‡∏ß‡∏ó‡∏µ‡πà‡πÄ‡∏°‡∏µ‡∏¢‡∏ô‡∏°‡∏≤‡∏£‡πå",
        graph: "https://geofon.gfz.de/waveform/qplot/NPW.active.png"
      },
      {
        lat: 5.18388, lng: 97.1385,
        name: "‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ‡∏ï‡∏£‡∏ß‡∏à‡∏ß‡∏±‡∏î‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô‡πÑ‡∏´‡∏ß‡∏•‡∏Å‡πÄ‡∏ã‡∏≠‡∏°‡∏≤‡πÄ‡∏ß",
        description: "‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ‡∏ï‡∏£‡∏ß‡∏à‡∏ß‡∏±‡∏î‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô‡πÑ‡∏´‡∏ß‡∏™‡∏∏‡∏°‡∏≤‡∏ï‡∏£‡∏≤‡πÄ‡∏´‡∏ô‡∏∑‡∏≠",
        graph: "https://geofon.gfz.de/waveform/qplot/LHMI.active.png"
      }
    ];

    // --- MAP SETUP ---
    const map = L.map('map', { preferCanvas: true }).setView([13.7, 100.5], 5);

    const baseLayers = {
      "osm": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'OSM' }),
      "satellite": L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Esri' }),
      "googleHybrid": L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', { attribution: 'Google' })
    };
    baseLayers.googleHybrid.addTo(map);

    // Layers
    const markerCluster = L.markerClusterGroup({ maxClusterRadius: 50 });
    const faultLineLayer = L.layerGroup().addTo(map);
    const tsunamiLayer = L.layerGroup().addTo(map);
    const stationLayer = L.layerGroup().addTo(map);
    
    map.addLayer(markerCluster);

    // --- HELPER FUNCTIONS ---
    function formatThaiTime(isoDateStr) {
        if (!isoDateStr || isoDateStr === "Invalid Date") return "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏ß‡∏•‡∏≤";
        try {
            const d = new Date(isoDateStr);
            if (isNaN(d.getTime())) return isoDateStr; 
            
            return d.toLocaleString('th-TH', {
                timeZone: 'Asia/Bangkok',
                day: '2-digit', month: 'short', year: '2-digit',
                hour: '2-digit', minute: '2-digit'
            }) + " ‡∏ô.";
        } catch (e) { return isoDateStr; }
    }

    function getMagColorClass(mag) {
        if (mag < 2) return 'mag-1';
        if (mag < 3) return 'mag-2';
        if (mag < 4) return 'mag-3';
        if (mag < 5) return 'mag-4';
        if (mag < 6) return 'mag-5';
        if (mag < 7) return 'mag-6';
        return 'mag-7';
    }

    function updateStats(events) {
        document.getElementById('stat-count').textContent = events.length;
        if (events.length > 0) {
            const mags = events.map(e => e.magnitude);
            const depths = events.map(e => e.depth);
            document.getElementById('stat-max').textContent = Math.max(...mags).toFixed(1);
            const avgDepth = depths.reduce((a, b) => a + b, 0) / depths.length;
            document.getElementById('stat-depth').textContent = avgDepth.toFixed(1) + " ‡∏Å‡∏°.";
        } else {
            document.getElementById('stat-max').textContent = "-";
            document.getElementById('stat-depth').textContent = "-";
        }
        document.getElementById('stat-update').textContent = new Date().toLocaleTimeString('th-TH');
    }

    // --- STATIC MARKER RENDERER ---
    function initStaticMarkers() {
        tsunamiBuoys.forEach(buoy => {
            const popupContent = `
                <div class="popup-content" style="font-family:'Sarabun'">
                    <h4 style="margin:0;color:#005c97">${buoy.name}</h4>
                    <hr style="margin:5px 0;opacity:0.3">
                    <small>${buoy.description}</small><br>
                    <b>‡∏û‡∏¥‡∏Å‡∏±‡∏î:</b> ${buoy.lat.toFixed(3)}, ${buoy.lng.toFixed(3)}
                    <div class="graph-frame">
                        <img src="${buoy.graph}" class="fullscreen-trigger" alt="Graph" title="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ç‡∏¢‡∏≤‡∏¢">
                    </div>
                    <div style="text-align:center;font-size:0.8rem;color:#666;margin-top:2px;">(‡πÅ‡∏ï‡∏∞‡∏ó‡∏µ‡πà‡∏£‡∏π‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ç‡∏¢‡∏≤‡∏¢)</div>
                </div>
            `;
            L.marker([buoy.lat, buoy.lng], { icon: tsunamiIcon, title: buoy.name })
             .bindPopup(popupContent)
             .addTo(tsunamiLayer);
        });

        seismicStations.forEach(st => {
            const popupContent = `
                <div class="popup-content" style="font-family:'Sarabun'">
                    <h4 style="margin:0;color:#9c27b0">${st.name}</h4>
                    <hr style="margin:5px 0;opacity:0.3">
                    <small>${st.description}</small>
                    <div class="graph-frame">
                        <img src="${st.graph}" class="fullscreen-trigger" alt="Graph" title="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ç‡∏¢‡∏≤‡∏¢">
                    </div>
                    <div style="text-align:center;font-size:0.8rem;color:#666;margin-top:2px;">(‡πÅ‡∏ï‡∏∞‡∏ó‡∏µ‡πà‡∏£‡∏π‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ç‡∏¢‡∏≤‡∏¢)</div>
                </div>
            `;
            L.marker([st.lat, st.lng], { icon: stationIcon, title: st.name })
             .bindPopup(popupContent)
             .addTo(stationLayer);
        });
    }

    // --- EARTHQUAKE DATA RENDERING ---
    function renderData(events) {
        markerCluster.clearLayers();
        const listContainer = document.getElementById('event-list');
        listContainer.innerHTML = "";

        events.forEach(evt => {
            const linkBtn = evt.link ? `<br><a href="${evt.link}" target="_blank" class="tmd-link-btn">üîó ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</a>` : '';
            const popupContent = `
                <div style="font-family:'Sarabun'">
                    <h4 style="margin:0;color:#005c97">${evt.place}</h4>
                    <hr style="margin:5px 0;opacity:0.3">
                    <b>‡∏Ç‡∏ô‡∏≤‡∏î:</b> <span style="color:#d32f2f;font-size:1.1em">${evt.magnitude}</span><br>
                    <b>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏∂‡∏Å:</b> ${evt.depth} ‡∏Å‡∏°.<br>
                    <b>‡πÄ‡∏ß‡∏•‡∏≤:</b> ${formatThaiTime(evt.time)}<br>
                    <small style="color:#666">${evt.details}</small>
                    ${linkBtn}
                </div>
            `;
            const marker = L.marker([evt.lat, evt.lng], { icon: quakeIcon }).bindPopup(popupContent);
            markerCluster.addLayer(marker);

            const item = document.createElement('div');
            item.className = 'event-item';
            item.innerHTML = `
                <div style="display:flex; align-items:center;">
                    <div class="mag-badge ${getMagColorClass(evt.magnitude)}">${evt.magnitude}</div>
                    <div style="flex:1">
                        <div style="font-weight:600;font-size:0.95rem;margin-bottom:3px">${evt.place}</div>
                        <div style="font-size:0.85rem;color:#ddd">
                           üïí ${formatThaiTime(evt.time)} | üìâ ‡∏•‡∏∂‡∏Å ${evt.depth} ‡∏Å‡∏°.
                        </div>
                    </div>
                </div>
            `;
            item.onclick = () => {
                map.setView([evt.lat, evt.lng], 10);
                marker.openPopup();
                document.querySelectorAll('.event-item').forEach(el => el.classList.remove('active'));
                item.classList.add('active');
            };
            listContainer.appendChild(item);
        });

        if (events.length > 0) {
            map.fitBounds(markerCluster.getBounds(), { padding: [50, 50] });
        }
        updateStats(events);
    }

    // --- API LOADING ---
    async function loadDataFromTMD() {
        const loading = document.getElementById('loading');
        loading.style.display = 'block';
        loading.textContent = 'üáπüá≠ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• TMD...';
        let xmlText = null;
        let success = false;

        for (const proxy of PROXY_LIST) {
            try {
                const response = await fetch(proxy + encodeURIComponent(TMD_FEED_URL));
                if (response.ok) {
                    xmlText = await response.text();
                    success = true;
                    break;
                }
            } catch (e) { console.warn(`Proxy failed: ${proxy}`); }
        }

        if (!success || !xmlText) {
            loading.style.display = 'none';
            alert('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ (Proxy ‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤)');
            return;
        }

        try {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlText, "text/xml");
            const items = xmlDoc.getElementsByTagName("item");
            const events = [];

            for (let i = 0; i < items.length; i++) {
                const item = items[i];
                const getTag = (name) => {
                    let el = item.getElementsByTagName(name)[0];
                    if (!el) el = item.getElementsByTagName(name.replace("tmd", "tmd:").replace("geo", "geo:"))[0];
                    return el ? el.textContent : null;
                };

                const lat = parseFloat(getTag("geolat") || getTag("geo:lat"));
                const lng = parseFloat(getTag("geolong") || getTag("geo:long"));
                const link = getTag("link");
                
                let timeStr = getTag("tmdtime") || getTag("tmd:time");
                if (timeStr) {
                    timeStr = timeStr.trim();
                    timeStr = timeStr.replace(" ", "T"); 
                    if (!timeStr.endsWith("Z")) timeStr += "Z"; 
                }

                if (!isNaN(lat) && !isNaN(lng)) {
                    events.push({
                        lat: lat, lng: lng,
                        magnitude: parseFloat(getTag("tmdmagnitude") || getTag("tmd:magnitude")),
                        depth: parseFloat(getTag("tmddepth") || getTag("tmd:depth")),
                        place: getTag("title"), time: timeStr,
                        details: getTag("tmdetc") || "",
                        link: link
                    });
                }
            }
            renderData(events);
            loading.style.display = 'none';
        } catch (e) {
            console.error(e);
            loading.textContent = 'Error parsing XML';
            setTimeout(() => loading.style.display = 'none', 3000);
        }
    }

    async function loadDataFromUSGS() {
        const loading = document.getElementById('loading');
        loading.style.display = 'block';
        loading.textContent = 'üåç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• USGS...';

        try {
            const res = await fetch(USGS_FEED_URL);
            const data = await res.json();
            const events = data.features.map(f => ({
                lat: f.geometry.coordinates[1],
                lng: f.geometry.coordinates[0],
                depth: f.geometry.coordinates[2],
                magnitude: f.properties.mag,
                place: f.properties.place,
                time: f.properties.time,
                details: "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å USGS Feed",
                link: f.properties.url
            }));
            renderData(events);
            loading.style.display = 'none';
        } catch (e) {
            console.error(e);
            alert("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• USGS ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
            loading.style.display = 'none';
        }
    }

    // --- FILE INPUT HANDLING (Fixed) ---
    document.getElementById('gpxInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(evt) {
            try {
                // 1. Parse JSON
                const geojson = JSON.parse(evt.target.result);
                
                // 2. Clear old layers
                faultLineLayer.clearLayers();
                
                // 3. Add new layer
                const layer = L.geoJSON(geojson, {
                    style: { color: "#d32f2f", weight: 2, opacity: 0.7 },
                    onEachFeature: (feature, layer) => {
                        if (feature.properties && feature.properties.name) {
                            layer.bindPopup(`<b>‡∏£‡∏≠‡∏¢‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô:</b> ${feature.properties.name}`);
                        }
                    }
                });
                layer.addTo(faultLineLayer);

                // 4. Success Check
                if (faultLineLayer.getLayers().length > 0) {
                     alert(`‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå ${file.name} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
                     
                     // Try to fit bounds (ignore error if global/complex geometry)
                     try {
                         const bounds = layer.getBounds();
                         if(bounds.isValid()) map.fitBounds(bounds);
                     } catch(err) {
                         console.warn("Auto-zoom failed (ignored):", err);
                     }
                } else {
                    throw new Error("No visible layers in GeoJSON");
                }

            } catch (err) {
                console.error(err);
                alert("‚ùå ‡πÑ‡∏ü‡∏•‡πå GeoJSON ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö)"); 
            }
        };
        reader.readAsText(file);
    });

    // Event Listeners
    document.getElementById('load-tmd').addEventListener('click', loadDataFromTMD);
    document.getElementById('load-usgs').addEventListener('click', loadDataFromUSGS);

    document.getElementById('clear-data').addEventListener('click', () => {
        markerCluster.clearLayers();
        faultLineLayer.clearLayers();
        document.getElementById('event-list').innerHTML = "";
        updateStats([]);
        document.getElementById('gpxInput').value = "";
    });

    document.getElementById('map-type').addEventListener('change', function(e) {
        for (let key in baseLayers) map.removeLayer(baseLayers[key]);
        baseLayers[e.target.value].addTo(map);
    });

    // Image Viewer
    document.addEventListener('click', function(e) {
      if (e.target.classList.contains('fullscreen-trigger')) {
        document.getElementById('fullscreenImage').src = e.target.src;
        document.getElementById('fullscreenDialog').showModal();
      }
    });

    // Clock
    setInterval(() => {
        const now = new Date();
        document.getElementById('time-display').textContent = now.toLocaleTimeString('th-TH');
        document.getElementById('date-display').textContent = now.toLocaleDateString('th-TH', {
            weekday: 'long', day: 'numeric', month: 'long', year: 'numeric'
        });
    }, 1000);

    // Initial Load
    initStaticMarkers();
    
  </script>
</body>
</html>
